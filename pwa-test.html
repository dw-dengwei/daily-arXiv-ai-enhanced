<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="PWAæµ‹è¯•é¡µé¢ - Daily arXiv AI Enhanced">
    <meta name="theme-color" content="#2196f3">
    <title>PWAæµ‹è¯• - Daily arXiv AI Enhanced</title>
    <link rel="icon" type="image/png" href="assets/logo2-removebg-preview.png">
    <link rel="manifest" href="/manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            background: linear-gradient(135deg, #2196f3, #21cbf3);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .test-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }

        .test-card h2 {
            color: #2196f3;
            margin-bottom: 1rem;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .test-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .test-item:last-child {
            border-bottom: none;
        }

        .test-label {
            flex: 1;
            font-weight: 500;
        }

        .test-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-pass {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .status-fail {
            background: #ffebee;
            color: #c62828;
        }

        .status-unknown {
            background: #fff3e0;
            color: #ef6c00;
        }

        .test-button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            margin: 0.25rem;
        }

        .test-button:hover {
            background: #1976d2;
            transform: translateY(-1px);
        }

        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .test-button.secondary {
            background: #6c757d;
        }

        .test-button.success {
            background: #28a745;
        }

        .test-button.danger {
            background: #dc3545;
        }

        .test-log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 1rem;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.875rem;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 1rem;
        }

        .info-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .info-item {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            border-left: 4px solid #2196f3;
        }

        .info-label {
            font-weight: 600;
            color: #2196f3;
            margin-bottom: 0.5rem;
        }

        .info-value {
            color: #666;
            word-break: break-all;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: #2196f3;
            text-decoration: none;
            font-weight: 500;
            margin-bottom: 2rem;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }

        .back-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .header h1 {
                font-size: 2rem;
            }

            .test-grid {
                grid-template-columns: 1fr;
            }

            .test-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-button">
            â† è¿”å›ä¸»é¡µ
        </a>

        <div class="header">
            <h1>ğŸ§ª PWA åŠŸèƒ½æµ‹è¯•</h1>
            <p>æ£€æµ‹å’ŒéªŒè¯Progressive Web Appçš„å„é¡¹åŠŸèƒ½</p>
        </div>

        <div class="test-grid">
            <!-- åŸºç¡€æ”¯æŒæµ‹è¯• -->
            <div class="test-card">
                <h2>ğŸ”§ åŸºç¡€APIæ”¯æŒ</h2>
                <div class="test-item">
                    <span class="test-label">Service Worker</span>
                    <span class="test-status" id="sw-support">æ£€æµ‹ä¸­...</span>
                </div>
                <div class="test-item">
                    <span class="test-label">Cache API</span>
                    <span class="test-status" id="cache-support">æ£€æµ‹ä¸­...</span>
                </div>
                <div class="test-item">
                    <span class="test-label">Fetch API</span>
                    <span class="test-status" id="fetch-support">æ£€æµ‹ä¸­...</span>
                </div>
                <div class="test-item">
                    <span class="test-label">Push API</span>
                    <span class="test-status" id="push-support">æ£€æµ‹ä¸­...</span>
                </div>
                <div class="test-item">
                    <span class="test-label">Notification API</span>
                    <span class="test-status" id="notification-support">æ£€æµ‹ä¸­...</span>
                </div>
                <div class="test-item">
                    <span class="test-label">IndexedDB</span>
                    <span class="test-status" id="idb-support">æ£€æµ‹ä¸­...</span>
                </div>
            </div>

            <!-- PWAçŠ¶æ€æµ‹è¯• -->
            <div class="test-card">
                <h2>ğŸ“± PWAçŠ¶æ€</h2>
                <div class="test-item">
                    <span class="test-label">å®‰è£…æç¤ºå¯ç”¨</span>
                    <span class="test-status" id="install-prompt">æ£€æµ‹ä¸­...</span>
                </div>
                <div class="test-item">
                    <span class="test-label">å·²å®‰è£…çŠ¶æ€</span>
                    <span class="test-status" id="installed-status">æ£€æµ‹ä¸­...</span>
                </div>
                <div class="test-item">
                    <span class="test-label">æ˜¾ç¤ºæ¨¡å¼</span>
                    <span class="test-status" id="display-mode">æ£€æµ‹ä¸­...</span>
                </div>
                <div class="test-item">
                    <span class="test-label">Service WorkerçŠ¶æ€</span>
                    <span class="test-status" id="sw-status">æ£€æµ‹ä¸­...</span>
                </div>
                <div style="margin-top: 1rem;">
                    <button class="test-button" id="install-test-btn">è§¦å‘å®‰è£…æç¤º</button>
                    <button class="test-button secondary" id="refresh-status-btn">åˆ·æ–°çŠ¶æ€</button>
                </div>
            </div>

            <!-- ç¼“å­˜æµ‹è¯• -->
            <div class="test-card">
                <h2>ğŸ—„ï¸ ç¼“å­˜åŠŸèƒ½</h2>
                <div class="test-item">
                    <span class="test-label">ç¼“å­˜æ•°é‡</span>
                    <span class="test-status" id="cache-count">æ£€æµ‹ä¸­...</span>
                </div>
                <div class="test-item">
                    <span class="test-label">ç¼“å­˜å¤§å°</span>
                    <span class="test-status" id="cache-size">è®¡ç®—ä¸­...</span>
                </div>
                <div class="test-item">
                    <span class="test-label">ç¦»çº¿é¡µé¢å¯ç”¨</span>
                    <span class="test-status" id="offline-available">æ£€æµ‹ä¸­...</span>
                </div>
                <div style="margin-top: 1rem;">
                    <button class="test-button" id="test-cache-btn">æµ‹è¯•ç¼“å­˜</button>
                    <button class="test-button" id="test-offline-btn">æµ‹è¯•ç¦»çº¿</button>
                    <button class="test-button danger" id="clear-cache-btn">æ¸…ç†ç¼“å­˜</button>
                </div>
            </div>

            <!-- ç½‘ç»œæµ‹è¯• -->
            <div class="test-card">
                <h2>ğŸŒ ç½‘ç»œåŠŸèƒ½</h2>
                <div class="test-item">
                    <span class="test-label">åœ¨çº¿çŠ¶æ€</span>
                    <span class="test-status" id="online-status">æ£€æµ‹ä¸­...</span>
                </div>
                <div class="test-item">
                    <span class="test-label">è¿æ¥ç±»å‹</span>
                    <span class="test-status" id="connection-type">æ£€æµ‹ä¸­...</span>
                </div>
                <div class="test-item">
                    <span class="test-label">æ•°æ®è·å–</span>
                    <span class="test-status" id="fetch-test">æœªæµ‹è¯•</span>
                </div>
                <div style="margin-top: 1rem;">
                    <button class="test-button" id="test-fetch-btn">æµ‹è¯•æ•°æ®è·å–</button>
                    <button class="test-button secondary" id="simulate-offline-btn">æ¨¡æ‹Ÿç¦»çº¿</button>
                </div>
            </div>
        </div>

        <!-- ç³»ç»Ÿä¿¡æ¯ -->
        <div class="info-section">
            <h2 style="color: #2196f3; margin-bottom: 1.5rem;">ğŸ“Š ç³»ç»Ÿä¿¡æ¯</h2>
            <div class="info-grid" id="system-info">
                <!-- ç³»ç»Ÿä¿¡æ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€å¡«å…… -->
            </div>
        </div>

        <!-- æµ‹è¯•æ—¥å¿— -->
        <div class="info-section" style="margin-top: 2rem;">
            <h2 style="color: #2196f3; margin-bottom: 1rem;">ğŸ“ æµ‹è¯•æ—¥å¿—</h2>
            <button class="test-button secondary" id="clear-log-btn">æ¸…ç©ºæ—¥å¿—</button>
            <div class="test-log" id="test-log"></div>
        </div>
    </div>

    <script>
        class PWATester {
            constructor() {
                this.log = [];
                this.init();
            }

            init() {
                this.logMessage('PWA Tester åˆå§‹åŒ–å®Œæˆ');
                this.checkBasicSupport();
                this.checkPWAStatus();
                this.checkCacheInfo();
                this.checkNetworkInfo();
                this.updateSystemInfo();
                this.bindEvents();
            }

            logMessage(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
                this.log.push(logEntry);

                const logElement = document.getElementById('test-log');
                logElement.textContent = this.log.join('\n');
                logElement.scrollTop = logElement.scrollHeight;

                console.log(logEntry);
            }

            updateStatus(elementId, status, message = '') {
                const element = document.getElementById(elementId);
                if (!element) return;

                element.textContent = message || status;
                element.className = 'test-status';

                if (status === 'pass' || status === 'æ”¯æŒ' || status === 'å·²å®‰è£…' || status === 'åœ¨çº¿') {
                    element.classList.add('status-pass');
                } else if (status === 'fail' || status === 'ä¸æ”¯æŒ' || status === 'æœªå®‰è£…' || status === 'ç¦»çº¿') {
                    element.classList.add('status-fail');
                } else {
                    element.classList.add('status-unknown');
                }
            }

            checkBasicSupport() {
                this.logMessage('å¼€å§‹æ£€æŸ¥åŸºç¡€APIæ”¯æŒ...');

                // Service Worker
                const swSupported = 'serviceWorker' in navigator;
                this.updateStatus('sw-support', swSupported ? 'pass' : 'fail', swSupported ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ');
                this.logMessage(`Service Worker: ${swSupported ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ'}`);

                // Cache API
                const cacheSupported = 'caches' in window;
                this.updateStatus('cache-support', cacheSupported ? 'pass' : 'fail', cacheSupported ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ');
                this.logMessage(`Cache API: ${cacheSupported ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ'}`);

                // Fetch API
                const fetchSupported = 'fetch' in window;
                this.updateStatus('fetch-support', fetchSupported ? 'pass' : 'fail', fetchSupported ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ');
                this.logMessage(`Fetch API: ${fetchSupported ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ'}`);

                // Push API
                const pushSupported = 'serviceWorker' in navigator && 'PushManager' in window;
                this.updateStatus('push-support', pushSupported ? 'pass' : 'fail', pushSupported ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ');
                this.logMessage(`Push API: ${pushSupported ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ'}`);

                // Notification API
                const notificationSupported = 'Notification' in window;
                this.updateStatus('notification-support', notificationSupported ? 'pass' : 'fail', notificationSupported ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ');
                this.logMessage(`Notification API: ${notificationSupported ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ'}`);

                // IndexedDB
                const idbSupported = 'indexedDB' in window;
                this.updateStatus('idb-support', idbSupported ? 'pass' : 'fail', idbSupported ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ');
                this.logMessage(`IndexedDB: ${idbSupported ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ'}`);
            }

            checkPWAStatus() {
                this.logMessage('å¼€å§‹æ£€æŸ¥PWAçŠ¶æ€...');

                // å®‰è£…æç¤º
                const hasInstallPrompt = window.pwaManager && window.pwaManager.deferredPrompt;
                this.updateStatus('install-prompt', hasInstallPrompt ? 'pass' : 'fail', hasInstallPrompt ? 'å¯ç”¨' : 'ä¸å¯ç”¨');
                this.logMessage(`å®‰è£…æç¤º: ${hasInstallPrompt ? 'å¯ç”¨' : 'ä¸å¯ç”¨'}`);

                // å®‰è£…çŠ¶æ€
                const isInstalled = this.isAppInstalled();
                this.updateStatus('installed-status', isInstalled ? 'pass' : 'fail', isInstalled ? 'å·²å®‰è£…' : 'æœªå®‰è£…');
                this.logMessage(`å®‰è£…çŠ¶æ€: ${isInstalled ? 'å·²å®‰è£…' : 'æœªå®‰è£…'}`);

                // æ˜¾ç¤ºæ¨¡å¼
                const displayMode = this.getDisplayMode();
                this.updateStatus('display-mode', displayMode === 'standalone' ? 'pass' : 'unknown', displayMode);
                this.logMessage(`æ˜¾ç¤ºæ¨¡å¼: ${displayMode}`);

                // Service WorkerçŠ¶æ€
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.ready.then(registration => {
                        const swState = registration.active ? 'å·²æ¿€æ´»' : 'æœªæ¿€æ´»';
                        this.updateStatus('sw-status', registration.active ? 'pass' : 'fail', swState);
                        this.logMessage(`Service WorkerçŠ¶æ€: ${swState}`);
                    });
                } else {
                    this.updateStatus('sw-status', 'fail', 'ä¸æ”¯æŒ');
                }
            }

            async checkCacheInfo() {
                this.logMessage('å¼€å§‹æ£€æŸ¥ç¼“å­˜ä¿¡æ¯...');

                try {
                    const cacheNames = await caches.keys();
                    this.updateStatus('cache-count', 'pass', `${cacheNames.length} ä¸ª`);
                    this.logMessage(`ç¼“å­˜æ•°é‡: ${cacheNames.length}`);

                    let totalSize = 0;
                    for (const cacheName of cacheNames) {
                        const cache = await caches.open(cacheName);
                        const keys = await cache.keys();

                        for (const request of keys) {
                            try {
                                const response = await cache.match(request);
                                if (response) {
                                    const blob = await response.clone().blob();
                                    totalSize += blob.size;
                                }
                            } catch (e) {
                                // å¿½ç•¥å•ä¸ªæ–‡ä»¶é”™è¯¯
                            }
                        }
                    }

                    this.updateStatus('cache-size', 'pass', this.formatBytes(totalSize));
                    this.logMessage(`ç¼“å­˜å¤§å°: ${this.formatBytes(totalSize)}`);

                    // æ£€æŸ¥ç¦»çº¿é¡µé¢
                    const offlineResponse = await caches.match('/');
                    this.updateStatus('offline-available', offlineResponse ? 'pass' : 'fail', offlineResponse ? 'å¯ç”¨' : 'ä¸å¯ç”¨');
                    this.logMessage(`ç¦»çº¿é¡µé¢: ${offlineResponse ? 'å¯ç”¨' : 'ä¸å¯ç”¨'}`);

                } catch (error) {
                    this.logMessage(`ç¼“å­˜æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                    this.updateStatus('cache-count', 'fail', 'æ£€æŸ¥å¤±è´¥');
                    this.updateStatus('cache-size', 'fail', 'æ£€æŸ¥å¤±è´¥');
                    this.updateStatus('offline-available', 'fail', 'æ£€æŸ¥å¤±è´¥');
                }
            }

            checkNetworkInfo() {
                this.logMessage('å¼€å§‹æ£€æŸ¥ç½‘ç»œä¿¡æ¯...');

                // åœ¨çº¿çŠ¶æ€
                const isOnline = navigator.onLine;
                this.updateStatus('online-status', isOnline ? 'pass' : 'fail', isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿');
                this.logMessage(`ç½‘ç»œçŠ¶æ€: ${isOnline ? 'åœ¨çº¿' : 'ç¦»çº¿'}`);

                // è¿æ¥ä¿¡æ¯
                if ('connection' in navigator) {
                    const connection = navigator.connection;
                    const effectiveType = connection.effectiveType || 'æœªçŸ¥';
                    this.updateStatus('connection-type', 'pass', effectiveType);
                    this.logMessage(`è¿æ¥ç±»å‹: ${effectiveType}`);
                } else {
                    this.updateStatus('connection-type', 'unknown', 'ä¸æ”¯æŒ');
                    this.logMessage('è¿æ¥ä¿¡æ¯: ä¸æ”¯æŒ');
                }

                // ç›‘å¬ç½‘ç»œå˜åŒ–
                window.addEventListener('online', () => {
                    this.updateStatus('online-status', 'pass', 'åœ¨çº¿');
                    this.logMessage('ç½‘ç»œçŠ¶æ€å˜åŒ–: å·²è¿æ¥');
                });

                window.addEventListener('offline', () => {
                    this.updateStatus('online-status', 'fail', 'ç¦»çº¿');
                    this.logMessage('ç½‘ç»œçŠ¶æ€å˜åŒ–: å·²æ–­å¼€');
                });
            }

            updateSystemInfo() {
                const systemInfo = {
                    'ç”¨æˆ·ä»£ç†': navigator.userAgent,
                    'å¹³å°': navigator.platform,
                    'è¯­è¨€': navigator.language,
                    'æ—¶åŒº': Intl.DateTimeFormat().resolvedOptions().timeZone,
                    'å±å¹•åˆ†è¾¨ç‡': `${screen.width} Ã— ${screen.height}`,
                    'è§†çª—å¤§å°': `${window.innerWidth} Ã— ${window.innerHeight}`,
                    'è®¾å¤‡åƒç´ æ¯”': window.devicePixelRatio || 1,
                    'å†…å­˜': navigator.deviceMemory ? `${navigator.deviceMemory} GB` : 'æœªçŸ¥',
                    'ç¡¬ä»¶å¹¶å‘': navigator.hardwareConcurrency || 'æœªçŸ¥',
                    'è§¦æ‘¸æ”¯æŒ': 'ontouchstart' in window ? 'æ˜¯' : 'å¦'
                };

                const container = document.getElementById('system-info');
                container.innerHTML = '';

                Object.entries(systemInfo).forEach(([key, value]) => {
                    const item = document.createElement('div');
                    item.className = 'info-item';
                    item.innerHTML = `
                        <div class="info-label">${key}</div>
                        <div class="info-value">${value}</div>
                    `;
                    container.appendChild(item);
                });

                this.logMessage('ç³»ç»Ÿä¿¡æ¯æ›´æ–°å®Œæˆ');
            }

            bindEvents() {
                // å®‰è£…æµ‹è¯•æŒ‰é’®
                document.getElementById('install-test-btn').addEventListener('click', () => {
                    if (window.pwaManager && window.pwaManager.deferredPrompt) {
                        window.pwaManager.installApp();
                        this.logMessage('è§¦å‘å®‰è£…æç¤º');
                    } else {
                        this.logMessage('å®‰è£…æç¤ºä¸å¯ç”¨', 'warning');
                    }
                });

                // åˆ·æ–°çŠ¶æ€æŒ‰é’®
                document.getElementById('refresh-status-btn').addEventListener('click', () => {
                    this.checkPWAStatus();
                    this.logMessage('PWAçŠ¶æ€å·²åˆ·æ–°');
                });

                // æµ‹è¯•ç¼“å­˜æŒ‰é’®
                document.getElementById('test-cache-btn').addEventListener('click', () => {
                    this.testCache();
                });

                // æµ‹è¯•ç¦»çº¿æŒ‰é’®
                document.getElementById('test-offline-btn').addEventListener('click', () => {
                    this.testOffline();
                });

                // æ¸…ç†ç¼“å­˜æŒ‰é’®
                document.getElementById('clear-cache-btn').addEventListener('click', async () => {
                    if (confirm('ç¡®å®šè¦æ¸…ç†æ‰€æœ‰ç¼“å­˜å—ï¼Ÿ')) {
                        await this.clearAllCaches();
                    }
                });

                // æµ‹è¯•æ•°æ®è·å–æŒ‰é’®
                document.getElementById('test-fetch-btn').addEventListener('click', () => {
                    this.testFetch();
                });

                // æ¨¡æ‹Ÿç¦»çº¿æŒ‰é’®
                document.getElementById('simulate-offline-btn').addEventListener('click', () => {
                    this.simulateOffline();
                });

                // æ¸…ç©ºæ—¥å¿—æŒ‰é’®
                document.getElementById('clear-log-btn').addEventListener('click', () => {
                    this.log = [];
                    document.getElementById('test-log').textContent = '';
                    this.logMessage('æ—¥å¿—å·²æ¸…ç©º');
                });
            }

            async testCache() {
                this.logMessage('å¼€å§‹æµ‹è¯•ç¼“å­˜åŠŸèƒ½...');

                try {
                    const testUrl = '/assets/file-list.txt';
                    const cache = await caches.open('test-cache');

                    // æ·»åŠ åˆ°ç¼“å­˜
                    await cache.add(testUrl);
                    this.logMessage('æ–‡ä»¶å·²æ·»åŠ åˆ°ç¼“å­˜');

                    // ä»ç¼“å­˜è·å–
                    const cachedResponse = await cache.match(testUrl);
                    if (cachedResponse) {
                        this.logMessage('ç¼“å­˜æµ‹è¯•æˆåŠŸ');
                    }

                    // åˆ é™¤æµ‹è¯•ç¼“å­˜
                    await caches.delete('test-cache');
                    this.logMessage('æµ‹è¯•ç¼“å­˜å·²æ¸…ç†');

                } catch (error) {
                    this.logMessage(`ç¼“å­˜æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                }
            }

            async testOffline() {
                this.logMessage('å¼€å§‹æµ‹è¯•ç¦»çº¿åŠŸèƒ½...');

                try {
                    // æµ‹è¯•ç¼“å­˜çš„é¡µé¢
                    const response = await caches.match('/');
                    if (response) {
                        this.logMessage('ç¦»çº¿é¡µé¢å¯ç”¨');
                        this.updateStatus('offline-available', 'pass', 'å¯ç”¨');
                    } else {
                        this.logMessage('ç¦»çº¿é¡µé¢ä¸å¯ç”¨', 'warning');
                        this.updateStatus('offline-available', 'fail', 'ä¸å¯ç”¨');
                    }
                } catch (error) {
                    this.logMessage(`ç¦»çº¿æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                }
            }

            async clearAllCaches() {
                this.logMessage('å¼€å§‹æ¸…ç†æ‰€æœ‰ç¼“å­˜...');

                try {
                    const cacheNames = await caches.keys();
                    const deletePromises = cacheNames.map(name => caches.delete(name));
                    await Promise.all(deletePromises);

                    this.logMessage(`å·²æ¸…ç† ${cacheNames.length} ä¸ªç¼“å­˜`);
                    await this.checkCacheInfo();
                } catch (error) {
                    this.logMessage(`ç¼“å­˜æ¸…ç†å¤±è´¥: ${error.message}`, 'error');
                }
            }

            async testFetch() {
                this.logMessage('å¼€å§‹æµ‹è¯•æ•°æ®è·å–...');

                try {
                    const response = await fetch('/assets/file-list.txt');
                    if (response.ok) {
                        this.updateStatus('fetch-test', 'pass', 'æˆåŠŸ');
                        this.logMessage('æ•°æ®è·å–æµ‹è¯•æˆåŠŸ');
                    } else {
                        this.updateStatus('fetch-test', 'fail', 'å¤±è´¥');
                        this.logMessage(`æ•°æ®è·å–å¤±è´¥: ${response.status}`, 'warning');
                    }
                } catch (error) {
                    this.updateStatus('fetch-test', 'fail', 'é”™è¯¯');
                    this.logMessage(`æ•°æ®è·å–é”™è¯¯: ${error.message}`, 'error');
                }
            }

            simulateOffline() {
                this.logMessage('æ¨¡æ‹Ÿç¦»çº¿çŠ¶æ€ï¼ˆä»…UIæ›´æ–°ï¼‰');
                this.updateStatus('online-status', 'fail', 'ç¦»çº¿ï¼ˆæ¨¡æ‹Ÿï¼‰');

                setTimeout(() => {
                    this.updateStatus('online-status', navigator.onLine ? 'pass' : 'fail', navigator.onLine ? 'åœ¨çº¿' : 'ç¦»çº¿');
                    this.logMessage('æ¢å¤çœŸå®ç½‘ç»œçŠ¶æ€');
                }, 3000);
            }

            isAppInstalled() {
                return window.matchMedia('(display-mode: standalone)').matches ||
                       window.navigator.standalone ||
                       document.referrer.includes('android-app://');
            }

            getDisplayMode() {
                if (window.matchMedia('(display-mode: standalone)').matches) {
                    return 'standalone';
                } else if (window.matchMedia('(display-mode: minimal-ui)').matches) {
                    return 'minimal-ui';
                } else if (window.matchMedia('(display-mode: fullscreen)').matches) {
                    return 'fullscreen';
                } else {
                    return 'browser';
                }
            }

            formatBytes(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
        }

        // ç­‰å¾…PWAç®¡ç†å™¨åŠ è½½ååˆå§‹åŒ–æµ‹è¯•å™¨
        document.addEventListener('DOMContentLoaded', () => {
            const initTester = () => {
                window.pwaTester = new PWATester();
            };

            // å¦‚æœPWAç®¡ç†å™¨å·²åŠ è½½
            if (window.pwaManager) {
                initTester();
            } else {
                // ç­‰å¾…PWAç®¡ç†å™¨åŠ è½½
                const checkPWAManager = () => {
                    if (window.pwaManager) {
                        initTester();
                    } else {
                        setTimeout(checkPWAManager, 100);
                    }
                };
                checkPWAManager();
            }
        });

        // å¦‚æœæ²¡æœ‰PWAç®¡ç†å™¨ï¼Œä¹Ÿè¦åˆå§‹åŒ–åŸºæœ¬åŠŸèƒ½
        setTimeout(() => {
            if (!window.pwaTester) {
                window.pwaTester = new PWATester();
            }
        }, 1000);
    </script>

    <!-- åŠ è½½PWAç®¡ç†å™¨ -->
    <script src="js/pwa-manager.js?v=2.0.0"></script>
</body>
</html>
