<!doctype html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="description" content="PWAè®¾ç½® - Daily arXiv AI Enhanced" />
        <meta name="theme-color" content="#2196f3" />
        <title>PWAè®¾ç½® - Daily arXiv AI Enhanced</title>
        <link
            rel="icon"
            type="image/png"
            href="assets/logo2-removebg-preview.png"
        />
        <link rel="manifest" href="/manifest.json" />
        <link rel="stylesheet" href="css/styles.css" />
        <link rel="stylesheet" href="css/settings.css" />
        <style>
            /* PWAè®¾ç½®é¡µé¢ç‰¹æ®Šæ ·å¼ */
            .pwa-settings-container {
                max-width: 800px;
                margin: 2rem auto;
                padding: 0 1rem;
            }

            .pwa-status-card {
                background: linear-gradient(135deg, #2196f3, #21cbf3);
                color: white;
                border-radius: 12px;
                padding: 2rem;
                margin-bottom: 2rem;
                box-shadow: 0 4px 20px rgba(33, 150, 243, 0.3);
            }

            .pwa-status-title {
                font-size: 1.5rem;
                font-weight: 600;
                margin-bottom: 1rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .pwa-status-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 1rem;
                margin-bottom: 1.5rem;
            }

            .pwa-status-item {
                background: rgba(255, 255, 255, 0.1);
                border-radius: 8px;
                padding: 1rem;
                text-align: center;
                backdrop-filter: blur(10px);
            }

            .pwa-status-item .label {
                font-size: 0.875rem;
                opacity: 0.8;
                margin-bottom: 0.5rem;
            }

            .pwa-status-item .value {
                font-size: 1.25rem;
                font-weight: 600;
            }

            .pwa-status-item .status-indicator {
                display: inline-block;
                width: 12px;
                height: 12px;
                border-radius: 50%;
                margin-right: 0.5rem;
            }

            .status-online {
                background: #4caf50;
            }

            .status-offline {
                background: #ff9800;
            }

            .status-error {
                background: #f44336;
            }

            .pwa-settings-section {
                background: var(--card-bg);
                border-radius: 12px;
                padding: 2rem;
                margin-bottom: 2rem;
                border: 1px solid var(--border-color);
            }

            .pwa-settings-title {
                font-size: 1.25rem;
                font-weight: 600;
                margin-bottom: 1.5rem;
                color: var(--text-primary);
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .pwa-setting-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 1rem 0;
                border-bottom: 1px solid var(--border-color);
            }

            .pwa-setting-item:last-child {
                border-bottom: none;
            }

            .pwa-setting-info {
                flex: 1;
            }

            .pwa-setting-label {
                font-weight: 500;
                margin-bottom: 0.25rem;
                color: var(--text-primary);
            }

            .pwa-setting-description {
                font-size: 0.875rem;
                color: var(--text-secondary);
                line-height: 1.4;
            }

            .pwa-toggle-switch {
                position: relative;
                display: inline-block;
                width: 50px;
                height: 24px;
                background: var(--border-color);
                border-radius: 24px;
                cursor: pointer;
                transition: background 0.3s;
            }

            .pwa-toggle-switch.active {
                background: #2196f3;
            }

            .pwa-toggle-switch::after {
                content: "";
                position: absolute;
                top: 2px;
                left: 2px;
                width: 20px;
                height: 20px;
                background: white;
                border-radius: 50%;
                transition: transform 0.3s;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            }

            .pwa-toggle-switch.active::after {
                transform: translateX(26px);
            }

            .pwa-cache-info {
                background: #f5f5f5;
                border-radius: 8px;
                padding: 1.5rem;
                margin: 1rem 0;
            }

            .pwa-cache-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.5rem 0;
            }

            .pwa-button {
                background: #2196f3;
                color: white;
                border: none;
                border-radius: 6px;
                padding: 0.75rem 1.5rem;
                font-size: 0.875rem;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s;
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
            }

            .pwa-button:hover {
                background: #1976d2;
                transform: translateY(-1px);
            }

            .pwa-button.secondary {
                background: #6c757d;
            }

            .pwa-button.secondary:hover {
                background: #545b62;
            }

            .pwa-button.danger {
                background: #dc3545;
            }

            .pwa-button.danger:hover {
                background: #c82333;
            }

            .pwa-button.success {
                background: #28a745;
            }

            .pwa-button.success:hover {
                background: #218838;
            }

            .pwa-button:disabled {
                background: #6c757d;
                cursor: not-allowed;
                transform: none;
            }

            .pwa-alert {
                padding: 1rem;
                border-radius: 8px;
                margin: 1rem 0;
                display: flex;
                align-items: center;
                gap: 0.75rem;
            }

            .pwa-alert.info {
                background: #d1ecf1;
                color: #0c5460;
                border: 1px solid #b6d4db;
            }

            .pwa-alert.warning {
                background: #fff3cd;
                color: #856404;
                border: 1px solid #faeeba;
            }

            .pwa-alert.success {
                background: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }

            .pwa-alert.error {
                background: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }

            .pwa-loading {
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 2px solid #f3f3f3;
                border-top: 2px solid #2196f3;
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }

            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }

            .pwa-version-info {
                background: var(--card-bg);
                border: 1px solid var(--border-color);
                border-radius: 8px;
                padding: 1rem;
                font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
                font-size: 0.875rem;
                white-space: pre-line;
                color: var(--text-secondary);
            }

            @media (max-width: 768px) {
                .pwa-settings-container {
                    margin: 1rem auto;
                    padding: 0 0.5rem;
                }

                .pwa-status-card {
                    padding: 1.5rem;
                }

                .pwa-status-grid {
                    grid-template-columns: 1fr;
                }

                .pwa-settings-section {
                    padding: 1.5rem;
                }

                .pwa-setting-item {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 1rem;
                }
            }
        </style>
    </head>
    <body>
        <div class="app-container">
            <header>
                <div class="header-content">
                    <div class="header-left">
                        <a href="index.html" class="button secondary">
                            â† è¿”å›ä¸»é¡µ
                        </a>
                    </div>

                    <div class="header-center">
                        <h1>PWA è®¾ç½®</h1>
                    </div>

                    <div class="header-controls">
                        <a href="settings.html" class="button"> åº”ç”¨è®¾ç½® </a>
                    </div>
                </div>
            </header>

            <main class="pwa-settings-container">
                <!-- PWA çŠ¶æ€å¡ç‰‡ -->
                <div class="pwa-status-card">
                    <div class="pwa-status-title">ğŸ“± PWA åº”ç”¨çŠ¶æ€</div>
                    <div class="pwa-status-grid">
                        <div class="pwa-status-item">
                            <div class="label">åº”ç”¨ç‰ˆæœ¬</div>
                            <div class="value" id="appVersion">-</div>
                        </div>
                        <div class="pwa-status-item">
                            <div class="label">ç½‘ç»œçŠ¶æ€</div>
                            <div class="value" id="networkStatus">
                                <span
                                    class="status-indicator status-online"
                                ></span>
                                åœ¨çº¿
                            </div>
                        </div>
                        <div class="pwa-status-item">
                            <div class="label">å®‰è£…çŠ¶æ€</div>
                            <div class="value" id="installStatus">æœªå®‰è£…</div>
                        </div>
                        <div class="pwa-status-item">
                            <div class="label">Service Worker</div>
                            <div class="value" id="swStatus">æœªæ³¨å†Œ</div>
                        </div>
                    </div>

                    <div id="installPrompt" style="display: none">
                        <div class="pwa-alert info">
                            <span>ğŸ’¡</span>
                            <div>
                                <strong>å¯ä»¥å®‰è£…æ­¤åº”ç”¨ï¼</strong>
                                <p>å°†åº”ç”¨å®‰è£…åˆ°ä¸»å±å¹•ï¼Œè·å¾—æ›´å¥½çš„ä½¿ç”¨ä½“éªŒã€‚</p>
                            </div>
                        </div>
                        <button id="installButton" class="pwa-button success">
                            ğŸ“± å®‰è£…åº”ç”¨
                        </button>
                    </div>

                    <div id="updatePrompt" style="display: none">
                        <div class="pwa-alert warning">
                            <span>ğŸ”„</span>
                            <div>
                                <strong>å‘ç°æ–°ç‰ˆæœ¬ï¼</strong>
                                <p>
                                    æœ‰æ–°çš„åº”ç”¨æ›´æ–°å¯ç”¨ï¼Œå»ºè®®ç«‹å³æ›´æ–°ä»¥è·å¾—æœ€æ–°åŠŸèƒ½ã€‚
                                </p>
                            </div>
                        </div>
                        <button id="updateButton" class="pwa-button">
                            ğŸ”„ ç«‹å³æ›´æ–°
                        </button>
                    </div>
                </div>

                <!-- åŠŸèƒ½è®¾ç½® -->
                <div class="pwa-settings-section">
                    <div class="pwa-settings-title">âš™ï¸ åŠŸèƒ½è®¾ç½®</div>

                    <div class="pwa-setting-item">
                        <div class="pwa-setting-info">
                            <div class="pwa-setting-label">æ¨é€é€šçŸ¥</div>
                            <div class="pwa-setting-description">
                                æ¥æ”¶æ–°è®ºæ–‡å‘å¸ƒçš„æ¨é€é€šçŸ¥
                            </div>
                        </div>
                        <div
                            class="pwa-toggle-switch"
                            data-setting="notifications"
                        ></div>
                    </div>

                    <div class="pwa-setting-item">
                        <div class="pwa-setting-info">
                            <div class="pwa-setting-label">æ™ºèƒ½é¢„å–</div>
                            <div class="pwa-setting-description">
                                è‡ªåŠ¨é¢„å–æœ€æ–°è®ºæ–‡æ•°æ®ï¼Œæå‡ç¦»çº¿ä½“éªŒ
                            </div>
                        </div>
                        <div
                            class="pwa-toggle-switch active"
                            data-setting="prefetch"
                        ></div>
                    </div>

                    <div class="pwa-setting-item">
                        <div class="pwa-setting-info">
                            <div class="pwa-setting-label">åå°åŒæ­¥</div>
                            <div class="pwa-setting-description">
                                åœ¨åå°è‡ªåŠ¨åŒæ­¥æ•°æ®ï¼Œä¿æŒå†…å®¹æœ€æ–°
                            </div>
                        </div>
                        <div
                            class="pwa-toggle-switch active"
                            data-setting="backgroundSync"
                        ></div>
                    </div>

                    <div class="pwa-setting-item">
                        <div class="pwa-setting-info">
                            <div class="pwa-setting-label">è‡ªåŠ¨æ›´æ–°æ£€æŸ¥</div>
                            <div class="pwa-setting-description">
                                å®šæœŸæ£€æŸ¥åº”ç”¨æ›´æ–°ï¼ˆæ¯30åˆ†é’Ÿï¼‰
                            </div>
                        </div>
                        <div
                            class="pwa-toggle-switch active"
                            data-setting="autoUpdate"
                        ></div>
                    </div>
                </div>

                <!-- ç¼“å­˜ç®¡ç† -->
                <div class="pwa-settings-section">
                    <div class="pwa-settings-title">ğŸ—„ï¸ ç¼“å­˜ç®¡ç†</div>

                    <div class="pwa-cache-info">
                        <div class="pwa-cache-item">
                            <span>åº”ç”¨ç¼“å­˜å¤§å°</span>
                            <span id="cacheSize">è®¡ç®—ä¸­...</span>
                        </div>
                        <div class="pwa-cache-item">
                            <span>æ•°æ®æ–‡ä»¶æ•°é‡</span>
                            <span id="dataFiles">-</span>
                        </div>
                        <div class="pwa-cache-item">
                            <span>æœ€åæ›´æ–°æ—¶é—´</span>
                            <span id="lastUpdate">-</span>
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem; flex-wrap: wrap">
                        <button id="refreshCacheButton" class="pwa-button">
                            ğŸ”„ åˆ·æ–°ç¼“å­˜
                        </button>
                        <button id="clearCacheButton" class="pwa-button danger">
                            ğŸ—‘ï¸ æ¸…ç†ç¼“å­˜
                        </button>
                        <button
                            id="downloadOfflineButton"
                            class="pwa-button secondary"
                        >
                            ğŸ“¥ ä¸‹è½½ç¦»çº¿æ•°æ®
                        </button>
                    </div>

                    <div id="cacheAlert"></div>
                </div>

                <!-- ç³»ç»Ÿä¿¡æ¯ -->
                <div class="pwa-settings-section">
                    <div class="pwa-settings-title">ğŸ“Š ç³»ç»Ÿä¿¡æ¯</div>

                    <div class="pwa-version-info" id="systemInfo">
                        åŠ è½½ä¸­...
                    </div>
                </div>

                <!-- é«˜çº§é€‰é¡¹ -->
                <div class="pwa-settings-section">
                    <div class="pwa-settings-title">ğŸ”§ é«˜çº§é€‰é¡¹</div>

                    <div class="pwa-setting-item">
                        <div class="pwa-setting-info">
                            <div class="pwa-setting-label">å¼€å‘è€…æ¨¡å¼</div>
                            <div class="pwa-setting-description">
                                æ˜¾ç¤ºè¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯å’Œæ—¥å¿—
                            </div>
                        </div>
                        <div
                            class="pwa-toggle-switch"
                            data-setting="developerMode"
                        ></div>
                    </div>

                    <div
                        style="
                            display: flex;
                            gap: 1rem;
                            flex-wrap: wrap;
                            margin-top: 1.5rem;
                        "
                    >
                        <button
                            id="exportSettingsButton"
                            class="pwa-button secondary"
                        >
                            ğŸ“¤ å¯¼å‡ºè®¾ç½®
                        </button>
                        <button
                            id="importSettingsButton"
                            class="pwa-button secondary"
                        >
                            ğŸ“¥ å¯¼å…¥è®¾ç½®
                        </button>
                        <button
                            id="resetSettingsButton"
                            class="pwa-button danger"
                        >
                            ğŸ”„ é‡ç½®è®¾ç½®
                        </button>
                    </div>
                </div>
            </main>
        </div>

        <!-- æ–‡ä»¶è¾“å…¥ï¼ˆéšè—ï¼‰ -->
        <input
            type="file"
            id="importFileInput"
            accept=".json"
            style="display: none"
        />

        <!-- PWAç®¡ç†å™¨ -->
        <script src="js/pwa-manager.js?v=2.0.0"></script>

        <script>
            class PWASettingsManager {
                constructor() {
                    this.pwaManager = window.pwaManager;
                    this.settings = this.loadSettings();
                    this.init();
                }

                init() {
                    this.updateStatus();
                    this.bindEvents();
                    this.updateCacheInfo();
                    this.updateSystemInfo();

                    // å®šæœŸæ›´æ–°çŠ¶æ€
                    setInterval(() => this.updateStatus(), 5000);
                }

                bindEvents() {
                    // å®‰è£…æŒ‰é’®
                    document
                        .getElementById("installButton")
                        ?.addEventListener("click", () => {
                            this.pwaManager?.installApp();
                        });

                    // æ›´æ–°æŒ‰é’®
                    document
                        .getElementById("updateButton")
                        ?.addEventListener("click", () => {
                            this.pwaManager?.applyUpdate();
                        });

                    // åŠŸèƒ½å¼€å…³
                    document
                        .querySelectorAll(".pwa-toggle-switch")
                        .forEach((toggle) => {
                            toggle.addEventListener("click", (e) => {
                                const setting = e.target.dataset.setting;
                                this.toggleSetting(setting, e.target);
                            });
                        });

                    // ç¼“å­˜ç®¡ç†æŒ‰é’®
                    document
                        .getElementById("refreshCacheButton")
                        ?.addEventListener("click", () => {
                            this.refreshCache();
                        });

                    document
                        .getElementById("clearCacheButton")
                        ?.addEventListener("click", () => {
                            this.clearCache();
                        });

                    document
                        .getElementById("downloadOfflineButton")
                        ?.addEventListener("click", () => {
                            this.downloadOfflineData();
                        });

                    // é«˜çº§é€‰é¡¹æŒ‰é’®
                    document
                        .getElementById("exportSettingsButton")
                        ?.addEventListener("click", () => {
                            this.exportSettings();
                        });

                    document
                        .getElementById("importSettingsButton")
                        ?.addEventListener("click", () => {
                            document.getElementById("importFileInput").click();
                        });

                    document
                        .getElementById("importFileInput")
                        ?.addEventListener("change", (e) => {
                            this.importSettings(e.target.files[0]);
                        });

                    document
                        .getElementById("resetSettingsButton")
                        ?.addEventListener("click", () => {
                            this.resetSettings();
                        });
                }

                updateStatus() {
                    if (!this.pwaManager) return;

                    const status = this.pwaManager.getAppStatus();

                    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                    document.getElementById("appVersion").textContent =
                        status.version;

                    const networkStatus =
                        document.getElementById("networkStatus");
                    const indicator =
                        networkStatus.querySelector(".status-indicator");
                    if (status.isOnline) {
                        networkStatus.innerHTML =
                            '<span class="status-indicator status-online"></span>åœ¨çº¿';
                    } else {
                        networkStatus.innerHTML =
                            '<span class="status-indicator status-offline"></span>ç¦»çº¿';
                    }

                    document.getElementById("installStatus").textContent =
                        status.isInstalled ? "å·²å®‰è£…" : "æœªå®‰è£…";

                    document.getElementById("swStatus").textContent =
                        status.swRegistered ? "å·²æ³¨å†Œ" : "æœªæ³¨å†Œ";

                    // æ˜¾ç¤º/éšè—å®‰è£…å’Œæ›´æ–°æç¤º
                    const installPrompt =
                        document.getElementById("installPrompt");
                    const updatePrompt =
                        document.getElementById("updatePrompt");

                    if (!status.isInstalled && this.pwaManager.deferredPrompt) {
                        installPrompt.style.display = "block";
                    } else {
                        installPrompt.style.display = "none";
                    }

                    if (status.updateAvailable) {
                        updatePrompt.style.display = "block";
                    } else {
                        updatePrompt.style.display = "none";
                    }
                }

                toggleSetting(setting, toggleElement) {
                    const isActive = toggleElement.classList.contains("active");

                    if (isActive) {
                        toggleElement.classList.remove("active");
                        this.settings[setting] = false;
                    } else {
                        toggleElement.classList.add("active");
                        this.settings[setting] = true;
                    }

                    this.saveSettings();
                    this.applySetting(setting, this.settings[setting]);
                }

                applySetting(setting, value) {
                    if (!this.pwaManager) return;

                    switch (setting) {
                        case "notifications":
                            if (value) {
                                this.pwaManager.enableNotifications();
                            }
                            break;
                        case "prefetch":
                            this.pwaManager.options.enablePrefetch = value;
                            break;
                        case "backgroundSync":
                            this.pwaManager.options.enableBackgroundSync =
                                value;
                            break;
                        case "autoUpdate":
                            // å®ç°è‡ªåŠ¨æ›´æ–°é€»è¾‘
                            break;
                        case "developerMode":
                            if (value) {
                                console.log(
                                    "[PWA Settings] Developer mode enabled",
                                );
                            }
                            break;
                    }

                    this.pwaManager.saveSettings();
                }

                async updateCacheInfo() {
                    try {
                        // è®¡ç®—ç¼“å­˜å¤§å°
                        const cacheNames = await caches.keys();
                        let totalSize = 0;
                        let fileCount = 0;

                        for (const cacheName of cacheNames) {
                            const cache = await caches.open(cacheName);
                            const keys = await cache.keys();
                            fileCount += keys.length;

                            for (const request of keys) {
                                try {
                                    const response = await cache.match(request);
                                    if (response) {
                                        const size =
                                            await this.getResponseSize(
                                                response,
                                            );
                                        totalSize += size;
                                    }
                                } catch (error) {
                                    // å¿½ç•¥å•ä¸ªæ–‡ä»¶çš„é”™è¯¯
                                }
                            }
                        }

                        document.getElementById("cacheSize").textContent =
                            this.formatBytes(totalSize);
                        document.getElementById("dataFiles").textContent =
                            fileCount;

                        // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
                        const lastUpdate =
                            localStorage.getItem("pwa-last-update");
                        document.getElementById("lastUpdate").textContent =
                            lastUpdate
                                ? new Date(lastUpdate).toLocaleString()
                                : "ä»æœª";
                    } catch (error) {
                        console.error(
                            "[PWA Settings] Failed to get cache info:",
                            error,
                        );
                        document.getElementById("cacheSize").textContent =
                            "è®¡ç®—å¤±è´¥";
                    }
                }

                async getResponseSize(response) {
                    try {
                        const blob = await response.clone().blob();
                        return blob.size;
                    } catch (error) {
                        return 0;
                    }
                }

                formatBytes(bytes) {
                    if (bytes === 0) return "0 Bytes";
                    const k = 1024;
                    const sizes = ["Bytes", "KB", "MB", "GB"];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return (
                        parseFloat((bytes / Math.pow(k, i)).toFixed(2)) +
                        " " +
                        sizes[i]
                    );
                }

                updateSystemInfo() {
                    const info = {
                        ç”¨æˆ·ä»£ç†: navigator.userAgent,
                        å¹³å°: navigator.platform,
                        è¯­è¨€: navigator.language,
                        åœ¨çº¿çŠ¶æ€: navigator.onLine ? "åœ¨çº¿" : "ç¦»çº¿",
                        å±å¹•åˆ†è¾¨ç‡: `${screen.width}x${screen.height}`,
                        è§†çª—å¤§å°: `${window.innerWidth}x${window.innerHeight}`,
                        "Service Worker æ”¯æŒ":
                            "serviceWorker" in navigator ? "æ˜¯" : "å¦",
                        æ¨é€é€šçŸ¥æ”¯æŒ: "Notification" in window ? "æ˜¯" : "å¦",
                        "ç¼“å­˜ API æ”¯æŒ": "caches" in window ? "æ˜¯" : "å¦",
                        "IndexedDB æ”¯æŒ": "indexedDB" in window ? "æ˜¯" : "å¦",
                    };

                    const systemInfo = Object.entries(info)
                        .map(([key, value]) => `${key}: ${value}`)
                        .join("\n");

                    document.getElementById("systemInfo").textContent =
                        systemInfo;
                }

                async refreshCache() {
                    const button =
                        document.getElementById("refreshCacheButton");
                    const originalText = button.textContent;

                    button.innerHTML =
                        '<span class="pwa-loading"></span> åˆ·æ–°ä¸­...';
                    button.disabled = true;

                    try {
                        if (this.pwaManager?.swRegistration) {
                            await this.pwaManager.swRegistration.update();
                        }

                        // æ›´æ–°ç¼“å­˜ä¿¡æ¯
                        await this.updateCacheInfo();
                        localStorage.setItem(
                            "pwa-last-update",
                            new Date().toISOString(),
                        );

                        this.showAlert("success", "ç¼“å­˜åˆ·æ–°æˆåŠŸï¼");
                    } catch (error) {
                        console.error(
                            "[PWA Settings] Cache refresh failed:",
                            error,
                        );
                        this.showAlert(
                            "error",
                            "ç¼“å­˜åˆ·æ–°å¤±è´¥ï¼š" + error.message,
                        );
                    }

                    button.textContent = originalText;
                    button.disabled = false;
                }

                async clearCache() {
                    if (
                        !confirm("ç¡®å®šè¦æ¸…ç†æ‰€æœ‰ç¼“å­˜å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰ç¦»çº¿æ•°æ®ã€‚")
                    ) {
                        return;
                    }

                    const button = document.getElementById("clearCacheButton");
                    const originalText = button.textContent;

                    button.innerHTML =
                        '<span class="pwa-loading"></span> æ¸…ç†ä¸­...';
                    button.disabled = true;

                    try {
                        if (this.pwaManager) {
                            await this.pwaManager.clearCache();
                        }

                        // æ›´æ–°ç¼“å­˜ä¿¡æ¯
                        await this.updateCacheInfo();

                        this.showAlert("success", "ç¼“å­˜æ¸…ç†å®Œæˆï¼");
                    } catch (error) {
                        console.error(
                            "[PWA Settings] Cache clear failed:",
                            error,
                        );
                        this.showAlert(
                            "error",
                            "ç¼“å­˜æ¸…ç†å¤±è´¥ï¼š" + error.message,
                        );
                    }

                    button.textContent = originalText;
                    button.disabled = false;
                }

                async downloadOfflineData() {
                    const button = document.getElementById(
                        "downloadOfflineButton",
                    );
                    const originalText = button.textContent;

                    button.innerHTML =
                        '<span class="pwa-loading"></span> ä¸‹è½½ä¸­...';
                    button.disabled = true;

                    try {
                        // è·å–æœ€æ–°çš„è®ºæ–‡æ•°æ®æ–‡ä»¶
                        const response = await fetch("/assets/file-list.txt");
                        const fileList = await response.text();
                        const files = fileList
                            .split("\n")
                            .filter((line) => line.trim())
                            .slice(-5) // æœ€æ–°5ä¸ªæ–‡ä»¶
                            .map((file) => `/data/${file}`);

                        if (this.pwaManager) {
                            this.pwaManager.sendMessageToSW("PREFETCH_DATA", {
                                urls: files,
                            });
                        }

                        this.showAlert(
                            "success",
                            `å·²å¼€å§‹ä¸‹è½½ ${files.length} ä¸ªæ•°æ®æ–‡ä»¶`,
                        );
                    } catch (error) {
                        console.error("[PWA Settings] Download failed:", error);
                        this.showAlert("error", "ä¸‹è½½å¤±è´¥ï¼š" + error.message);
                    }

                    button.textContent = originalText;
                    button.disabled = false;
                }

                exportSettings() {
                    const exportData = {
                        pwaSettings: this.settings,
                        appSettings: {
                            preferredKeywords: JSON.parse(
                                localStorage.getItem("preferredKeywords") ||
                                    "[]",
                            ),
                            preferredAuthors: JSON.parse(
                                localStorage.getItem("preferredAuthors") ||
                                    "[]",
                            ),
                        },
                        timestamp: new Date().toISOString(),
                    };

                    const blob = new Blob(
                        [JSON.stringify(exportData, null, 2)],
                        { type: "application/json" },
                    );
                    const url = URL.createObjectURL(blob);

                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `pwa-settings-${new Date().toISOString().split("T")[0]}.json`;
                    a.click();

                    URL.revokeObjectURL(url);
                    this.showAlert("success", "è®¾ç½®å¯¼å‡ºæˆåŠŸï¼");
                }

                async importSettings(file) {
                    if (!file) return;

                    try {
                        const text = await file.text();
                        const importData = JSON.parse(text);

                        if (importData.pwaSettings) {
                            this.settings = {
                                ...this.settings,
                                ...importData.pwaSettings,
                            };
                            this.saveSettings();
                        }

                        if (importData.appSettings) {
                            if (importData.appSettings.preferredKeywords) {
                                localStorage.setItem(
                                    "preferredKeywords",
                                    JSON.stringify(
                                        importData.appSettings
                                            .preferredKeywords,
                                    ),
                                );
                            }
                            if (importData.appSettings.preferredAuthors) {
                                localStorage.setItem(
                                    "preferredAuthors",
                                    JSON.stringify(
                                        importData.appSettings.preferredAuthors,
                                    ),
                                );
                            }
                        }

                        this.showAlert(
                            "success",
                            "è®¾ç½®å¯¼å…¥æˆåŠŸï¼é¡µé¢å°†åœ¨3ç§’ååˆ·æ–°",
                        );
                        setTimeout(() => window.location.reload(), 3000);
                    } catch (error) {
                        console.error("[PWA Settings] Import failed:", error);
                        this.showAlert("error", "å¯¼å…¥å¤±è´¥ï¼š" + error.message);
                    }
                }

                resetSettings() {
                    if (!confirm("ç¡®å®šè¦é‡ç½®æ‰€æœ‰PWAè®¾ç½®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚")) {
                        return;
                    }

                    // é‡ç½®PWAè®¾ç½®
                    localStorage.removeItem("pwa-settings");
                    this.settings = this.getDefaultSettings();
                    this.saveSettings();

                    // æ›´æ–°UI
                    this.updateSettingsUI();

                    this.showAlert("success", "è®¾ç½®é‡ç½®å®Œæˆï¼");
                }

                showAlert(type, message) {
                    const alertDiv = document.getElementById("cacheAlert");
                    alertDiv.innerHTML = `
                        <div class="pwa-alert ${type}">
                            <span>${type === "success" ? "âœ…" : type === "warning" ? "âš ï¸" : type === "error" ? "âŒ" : "â„¹ï¸"}</span>
                            <div>${message}</div>
                        </div>
                    `;

                    setTimeout(() => {
                        alertDiv.innerHTML = "";
                    }, 5000);
                }

                loadSettings() {
                    const defaults = this.getDefaultSettings();
                    const saved = JSON.parse(
                        localStorage.getItem("pwa-settings") || "{}",
                    );
                    return { ...defaults, ...saved };
                }

                getDefaultSettings() {
                    return {
                        notifications: false,
                        prefetch: true,
                        backgroundSync: true,
                        autoUpdate: true,
                        developerMode: false,
                    };
                }

                saveSettings() {
                    localStorage.setItem(
                        "pwa-settings",
                        JSON.stringify(this.settings),
                    );
                }

                updateSettingsUI() {
                    document
                        .querySelectorAll(".pwa-toggle-switch")
                        .forEach((toggle) => {
                            const setting = toggle.dataset.setting;
                            if (this.settings[setting]) {
                                toggle.classList.add("active");
                            } else {
                                toggle.classList.remove("active");
                            }
                        });
                }
            }

            // åˆå§‹åŒ–PWAè®¾ç½®ç®¡ç†å™¨
            document.addEventListener("DOMContentLoaded", () => {
                if (window.pwaManager) {
                    window.pwaSettingsManager = new PWASettingsManager();
                } else {
                    // ç­‰å¾…PWAç®¡ç†å™¨åŠ è½½
                    const checkPWAManager = () => {
                        if (window.pwaManager) {
                            window.pwaSettingsManager =
                                new PWASettingsManager();
                        } else {
                            setTimeout(checkPWAManager, 100);
                        }
                    };
                    checkPWAManager();
                }
            });
        </script>
    </body>
</html>
