<!doctype html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="description" content="PWAËÆæÁΩÆ - Daily arXiv AI Enhanced" />
        <meta name="theme-color" content="#2196f3" />
        <title>PWAËÆæÁΩÆ - Daily arXiv AI Enhanced</title>
        <link
            rel="icon"
            type="image/png"
            href="assets/logo2-removebg-preview.png"
        />
        <link rel="manifest" href="/manifest.json" />
        <link rel="stylesheet" href="css/styles.css" />
        <link rel="stylesheet" href="css/settings.css" />
        <style>
            /* PWAËÆæÁΩÆÈ°µÈù¢ÁâπÊÆäÊ†∑Âºè */
            .pwa-settings-container {
                max-width: 800px;
                margin: 2rem auto;
                padding: 0 1rem;
            }

            .pwa-status-card {
                background: linear-gradient(135deg, #2196f3, #21cbf3);
                color: white;
                border-radius: 12px;
                padding: 2rem;
                margin-bottom: 2rem;
                box-shadow: 0 4px 20px rgba(33, 150, 243, 0.3);
            }

            .pwa-status-title {
                font-size: 1.5rem;
                font-weight: 600;
                margin-bottom: 1rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .pwa-status-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 1rem;
                margin-bottom: 1.5rem;
            }

            .pwa-status-item {
                background: rgba(255, 255, 255, 0.1);
                border-radius: 8px;
                padding: 1rem;
                text-align: center;
                backdrop-filter: blur(10px);
            }

            .pwa-status-item .label {
                font-size: 0.875rem;
                opacity: 0.8;
                margin-bottom: 0.5rem;
            }

            .pwa-status-item .value {
                font-size: 1.25rem;
                font-weight: 600;
            }

            .pwa-status-item .status-indicator {
                display: inline-block;
                width: 12px;
                height: 12px;
                border-radius: 50%;
                margin-right: 0.5rem;
            }

            .status-online {
                background: #4caf50;
            }

            .status-offline {
                background: #ff9800;
            }

            .status-error {
                background: #f44336;
            }

            .pwa-settings-section {
                background: var(--card-bg);
                border-radius: 12px;
                padding: 2rem;
                margin-bottom: 2rem;
                border: 1px solid var(--border-color);
            }

            .pwa-settings-title {
                font-size: 1.25rem;
                font-weight: 600;
                margin-bottom: 1.5rem;
                color: var(--text-primary);
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .pwa-setting-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 1rem 0;
                border-bottom: 1px solid var(--border-color);
            }

            .pwa-setting-item:last-child {
                border-bottom: none;
            }

            .pwa-setting-info {
                flex: 1;
            }

            .pwa-setting-label {
                font-weight: 500;
                margin-bottom: 0.25rem;
                color: var(--text-primary);
            }

            .pwa-setting-description {
                font-size: 0.875rem;
                color: var(--text-secondary);
                line-height: 1.4;
            }

            .pwa-toggle-switch {
                position: relative;
                display: inline-block;
                width: 50px;
                height: 24px;
                background: var(--border-color);
                border-radius: 24px;
                cursor: pointer;
                transition: background 0.3s;
            }

            .pwa-toggle-switch.active {
                background: #2196f3;
            }

            .pwa-toggle-switch::after {
                content: "";
                position: absolute;
                top: 2px;
                left: 2px;
                width: 20px;
                height: 20px;
                background: white;
                border-radius: 50%;
                transition: transform 0.3s;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            }

            .pwa-toggle-switch.active::after {
                transform: translateX(26px);
            }

            .pwa-cache-info {
                background: #f5f5f5;
                border-radius: 8px;
                padding: 1.5rem;
                margin: 1rem 0;
            }

            .pwa-cache-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.5rem 0;
            }

            .pwa-button {
                background: #2196f3;
                color: white;
                border: none;
                border-radius: 6px;
                padding: 0.75rem 1.5rem;
                font-size: 0.875rem;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s;
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
            }

            .pwa-button:hover {
                background: #1976d2;
                transform: translateY(-1px);
            }

            .pwa-button.secondary {
                background: #6c757d;
            }

            .pwa-button.secondary:hover {
                background: #545b62;
            }

            .pwa-button.danger {
                background: #dc3545;
            }

            .pwa-button.danger:hover {
                background: #c82333;
            }

            .pwa-button.success {
                background: #28a745;
            }

            .pwa-button.success:hover {
                background: #218838;
            }

            .pwa-button:disabled {
                background: #6c757d;
                cursor: not-allowed;
                transform: none;
            }

            .pwa-alert {
                padding: 1rem;
                border-radius: 8px;
                margin: 1rem 0;
                display: flex;
                align-items: center;
                gap: 0.75rem;
            }

            .pwa-alert.info {
                background: #d1ecf1;
                color: #0c5460;
                border: 1px solid #b6d4db;
            }

            .pwa-alert.warning {
                background: #fff3cd;
                color: #856404;
                border: 1px solid #faeeba;
            }

            .pwa-alert.success {
                background: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }

            .pwa-alert.error {
                background: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }

            .pwa-loading {
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 2px solid #f3f3f3;
                border-top: 2px solid #2196f3;
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }

            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }

            .pwa-version-info {
                background: var(--card-bg);
                border: 1px solid var(--border-color);
                border-radius: 8px;
                padding: 1rem;
                font-family: "Monaco", "Menlo", "Ubuntu Mono", monospace;
                font-size: 0.875rem;
                white-space: pre-line;
                color: var(--text-secondary);
            }

            @media (max-width: 768px) {
                .pwa-settings-container {
                    margin: 1rem auto;
                    padding: 0 0.5rem;
                }

                .pwa-status-card {
                    padding: 1.5rem;
                }

                .pwa-status-grid {
                    grid-template-columns: 1fr;
                }

                .pwa-settings-section {
                    padding: 1.5rem;
                }

                .pwa-setting-item {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 1rem;
                }
            }
        </style>
    </head>
    <body>
        <div class="app-container">
            <header>
                <div class="header-content">
                    <div class="header-left">
                        <a href="index.html" class="button secondary">
                            ‚Üê ËøîÂõû‰∏ªÈ°µ
                        </a>
                    </div>

                    <div class="header-center">
                        <h1>PWA ËÆæÁΩÆ</h1>
                    </div>

                    <div class="header-controls">
                        <a href="settings.html" class="button"> Â∫îÁî®ËÆæÁΩÆ </a>
                    </div>
                </div>
            </header>

            <main class="pwa-settings-container">
                <!-- PWA Áä∂ÊÄÅÂç°Áâá -->
                <div class="pwa-status-card">
                    <div class="pwa-status-title">üì± PWA Â∫îÁî®Áä∂ÊÄÅ</div>
                    <div class="pwa-status-grid">
                        <div class="pwa-status-item">
                            <div class="label">Â∫îÁî®ÁâàÊú¨</div>
                            <div class="value" id="appVersion">-</div>
                        </div>
                        <div class="pwa-status-item">
                            <div class="label">ÁΩëÁªúÁä∂ÊÄÅ</div>
                            <div class="value" id="networkStatus">
                                <span
                                    class="status-indicator status-online"
                                ></span>
                                Âú®Á∫ø
                            </div>
                        </div>
                        <div class="pwa-status-item">
                            <div class="label">ÂÆâË£ÖÁä∂ÊÄÅ</div>
                            <div class="value" id="installStatus">Êú™ÂÆâË£Ö</div>
                        </div>
                        <div class="pwa-status-item">
                            <div class="label">Service Worker</div>
                            <div class="value" id="swStatus">Êú™Ê≥®ÂÜå</div>
                        </div>
                    </div>

                    <div id="installPrompt" style="display: none">
                        <div class="pwa-alert info">
                            <span>üí°</span>
                            <div>
                                <strong>ÂèØ‰ª•ÂÆâË£ÖÊ≠§Â∫îÁî®ÔºÅ</strong>
                                <p>Â∞ÜÂ∫îÁî®ÂÆâË£ÖÂà∞‰∏ªÂ±èÂπïÔºåËé∑ÂæóÊõ¥Â•ΩÁöÑ‰ΩøÁî®‰ΩìÈ™å„ÄÇ</p>
                            </div>
                        </div>
                        <button id="installButton" class="pwa-button success">
                            üì± ÂÆâË£ÖÂ∫îÁî®
                        </button>
                    </div>

                    <div id="updatePrompt" style="display: none">
                        <div class="pwa-alert warning">
                            <span>üîÑ</span>
                            <div>
                                <strong>ÂèëÁé∞Êñ∞ÁâàÊú¨ÔºÅ</strong>
                                <p>
                                    ÊúâÊñ∞ÁöÑÂ∫îÁî®Êõ¥Êñ∞ÂèØÁî®ÔºåÂª∫ËÆÆÁ´ãÂç≥Êõ¥Êñ∞‰ª•Ëé∑ÂæóÊúÄÊñ∞ÂäüËÉΩ„ÄÇ
                                </p>
                            </div>
                        </div>
                        <button id="updateButton" class="pwa-button">
                            üîÑ Á´ãÂç≥Êõ¥Êñ∞
                        </button>
                    </div>
                </div>

                <!-- ÂäüËÉΩËÆæÁΩÆ -->
                <div class="pwa-settings-section">
                    <div class="pwa-settings-title">‚öôÔ∏è ÂäüËÉΩËÆæÁΩÆ</div>

                    <div class="pwa-setting-item">
                        <div class="pwa-setting-info">
                            <div class="pwa-setting-label">Êé®ÈÄÅÈÄöÁü•</div>
                            <div class="pwa-setting-description">
                                Êé•Êî∂Êñ∞ËÆ∫ÊñáÂèëÂ∏ÉÁöÑÊé®ÈÄÅÈÄöÁü•
                            </div>
                        </div>
                        <div
                            class="pwa-toggle-switch"
                            data-setting="notifications"
                        ></div>
                    </div>

                    <div class="pwa-setting-item">
                        <div class="pwa-setting-info">
                            <div class="pwa-setting-label">Êô∫ËÉΩÈ¢ÑÂèñ</div>
                            <div class="pwa-setting-description">
                                Ëá™Âä®È¢ÑÂèñÊúÄÊñ∞ËÆ∫ÊñáÊï∞ÊçÆÔºåÊèêÂçáÁ¶ªÁ∫ø‰ΩìÈ™å
                            </div>
                        </div>
                        <div
                            class="pwa-toggle-switch active"
                            data-setting="prefetch"
                        ></div>
                    </div>

                    <div class="pwa-setting-item">
                        <div class="pwa-setting-info">
                            <div class="pwa-setting-label">ÂêéÂè∞ÂêåÊ≠•</div>
                            <div class="pwa-setting-description">
                                Âú®ÂêéÂè∞Ëá™Âä®ÂêåÊ≠•Êï∞ÊçÆÔºå‰øùÊåÅÂÜÖÂÆπÊúÄÊñ∞
                            </div>
                        </div>
                        <div
                            class="pwa-toggle-switch active"
                            data-setting="backgroundSync"
                        ></div>
                    </div>

                    <div class="pwa-setting-item">
                        <div class="pwa-setting-info">
                            <div class="pwa-setting-label">Ëá™Âä®Êõ¥Êñ∞Ê£ÄÊü•</div>
                            <div class="pwa-setting-description">
                                ÂÆöÊúüÊ£ÄÊü•Â∫îÁî®Êõ¥Êñ∞ÔºàÊØè30ÂàÜÈíüÔºâ
                            </div>
                        </div>
                        <div
                            class="pwa-toggle-switch active"
                            data-setting="autoUpdate"
                        ></div>
                    </div>
                </div>

                <!-- ÁºìÂ≠òÁÆ°ÁêÜ -->
                <div class="pwa-settings-section">
                    <div class="pwa-settings-title">üóÑÔ∏è ÁºìÂ≠òÁÆ°ÁêÜ</div>

                    <div class="pwa-cache-info">
                        <div class="pwa-cache-item">
                            <span>Â∫îÁî®ÁºìÂ≠òÂ§ßÂ∞è</span>
                            <span id="cacheSize">ËÆ°ÁÆó‰∏≠...</span>
                        </div>
                        <div class="pwa-cache-item">
                            <span>Êï∞ÊçÆÊñá‰ª∂Êï∞Èáè</span>
                            <span id="dataFiles">-</span>
                        </div>
                        <div class="pwa-cache-item">
                            <span>ÊúÄÂêéÊõ¥Êñ∞Êó∂Èó¥</span>
                            <span id="lastUpdate">-</span>
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem; flex-wrap: wrap">
                        <button id="refreshCacheButton" class="pwa-button">
                            üîÑ Âà∑Êñ∞ÁºìÂ≠ò
                        </button>
                        <button id="clearCacheButton" class="pwa-button danger">
                            üóëÔ∏è Ê∏ÖÁêÜÁºìÂ≠ò
                        </button>
                        <button
                            id="downloadOfflineButton"
                            class="pwa-button secondary"
                        >
                            üì• ‰∏ãËΩΩÁ¶ªÁ∫øÊï∞ÊçÆ
                        </button>
                    </div>

                    <div id="cacheAlert"></div>
                </div>

                <!-- Á≥ªÁªü‰ø°ÊÅØ -->
                <div class="pwa-settings-section">
                    <div class="pwa-settings-title">üìä Á≥ªÁªü‰ø°ÊÅØ</div>

                    <div class="pwa-version-info" id="systemInfo">
                        Âä†ËΩΩ‰∏≠...
                    </div>
                </div>

                <!-- È´òÁ∫ßÈÄâÈ°π -->
                <div class="pwa-settings-section">
                    <div class="pwa-settings-title">üîß È´òÁ∫ßÈÄâÈ°π</div>

                    <div class="pwa-setting-item">
                        <div class="pwa-setting-info">
                            <div class="pwa-setting-label">ÂºÄÂèëËÄÖÊ®°Âºè</div>
                            <div class="pwa-setting-description">
                                ÊòæÁ§∫ËØ¶ÁªÜÁöÑË∞ÉËØï‰ø°ÊÅØÂíåÊó•Âøó
                            </div>
                        </div>
                        <div
                            class="pwa-toggle-switch"
                            data-setting="developerMode"
                        ></div>
                    </div>

                    <div
                        style="
                            display: flex;
                            gap: 1rem;
                            flex-wrap: wrap;
                            margin-top: 1.5rem;
                        "
                    >
                        <button
                            id="exportSettingsButton"
                            class="pwa-button secondary"
                        >
                            üì§ ÂØºÂá∫ËÆæÁΩÆ
                        </button>
                        <button
                            id="importSettingsButton"
                            class="pwa-button secondary"
                        >
                            üì• ÂØºÂÖ•ËÆæÁΩÆ
                        </button>
                        <button
                            id="resetSettingsButton"
                            class="pwa-button danger"
                        >
                            üîÑ ÈáçÁΩÆËÆæÁΩÆ
                        </button>
                    </div>
                </div>
            </main>
        </div>

        <!-- Êñá‰ª∂ËæìÂÖ•ÔºàÈöêËóèÔºâ -->
        <input
            type="file"
            id="importFileInput"
            accept=".json"
            style="display: none"
        />

        <!-- PWAÁÆ°ÁêÜÂô® -->
        <script src="js/pwa-manager.js?v=2.0.0"></script>

        <script>
            class PWASettingsManager {
                constructor() {
                    this.pwaManager = window.pwaManager;
                    this.settings = this.loadSettings();
                    this.init();
                }

                init() {
                    this.updateStatus();
                    this.bindEvents();
                    this.updateCacheInfo();
                    this.updateSystemInfo();

                    // ÂÆöÊúüÊõ¥Êñ∞Áä∂ÊÄÅ
                    setInterval(() => this.updateStatus(), 5000);
                }

                bindEvents() {
                    // ÂÆâË£ÖÊåâÈíÆ
                    document
                        .getElementById("installButton")
                        ?.addEventListener("click", () => {
                            this.pwaManager?.installApp();
                        });

                    // Êõ¥Êñ∞ÊåâÈíÆ
                    document
                        .getElementById("updateButton")
                        ?.addEventListener("click", () => {
                            this.pwaManager?.applyUpdate();
                        });

                    // ÂäüËÉΩÂºÄÂÖ≥
                    document
                        .querySelectorAll(".pwa-toggle-switch")
                        .forEach((toggle) => {
                            toggle.addEventListener("click", (e) => {
                                const setting = e.target.dataset.setting;
                                this.toggleSetting(setting, e.target);
                            });
                        });

                    // ÁºìÂ≠òÁÆ°ÁêÜÊåâÈíÆ
                    document
                        .getElementById("refreshCacheButton")
                        ?.addEventListener("click", () => {
                            this.refreshCache();
                        });

                    document
                        .getElementById("clearCacheButton")
                        ?.addEventListener("click", () => {
                            this.clearCache();
                        });

                    document
                        .getElementById("downloadOfflineButton")
                        ?.addEventListener("click", () => {
                            this.downloadOfflineData();
                        });

                    // È´òÁ∫ßÈÄâÈ°πÊåâÈíÆ
                    document
                        .getElementById("exportSettingsButton")
                        ?.addEventListener("click", () => {
                            this.exportSettings();
                        });

                    document
                        .getElementById("importSettingsButton")
                        ?.addEventListener("click", () => {
                            document.getElementById("importFileInput").click();
                        });

                    document
                        .getElementById("importFileInput")
                        ?.addEventListener("change", (e) => {
                            this.importSettings(e.target.files[0]);
                        });

                    document
                        .getElementById("resetSettingsButton")
                        ?.addEventListener("click", () => {
                            this.resetSettings();
                        });
                }

                updateStatus() {
                    if (!this.pwaManager) return;

                    const status = this.pwaManager.getAppStatus();

                    // Êõ¥Êñ∞Áä∂ÊÄÅÊòæÁ§∫
                    document.getElementById("appVersion").textContent =
                        status.version;

                    const networkStatus =
                        document.getElementById("networkStatus");
                    const indicator =
                        networkStatus.querySelector(".status-indicator");
                    if (status.isOnline) {
                        networkStatus.innerHTML =
                            '<span class="status-indicator status-online"></span>Âú®Á∫ø';
                    } else {
                        networkStatus.innerHTML =
                            '<span class="status-indicator status-offline"></span>Á¶ªÁ∫ø';
                    }

                    document.getElementById("installStatus").textContent =
                        status.isInstalled ? "Â∑≤ÂÆâË£Ö" : "Êú™ÂÆâË£Ö";

                    document.getElementById("swStatus").textContent =
                        status.swRegistered ? "Â∑≤Ê≥®ÂÜå" : "Êú™Ê≥®ÂÜå";

                    // ÊòæÁ§∫/ÈöêËóèÂÆâË£ÖÂíåÊõ¥Êñ∞ÊèêÁ§∫
                    const installPrompt =
                        document.getElementById("installPrompt");
                    const updatePrompt =
                        document.getElementById("updatePrompt");

                    if (!status.isInstalled && this.pwaManager.deferredPrompt) {
                        installPrompt.style.display = "block";
                    } else {
                        installPrompt.style.display = "none";
                    }

                    if (status.updateAvailable) {
                        updatePrompt.style.display = "block";
                    } else {
                        updatePrompt.style.display = "none";
                    }
                }

                toggleSetting(setting, toggleElement) {
                    const isActive = toggleElement.classList.contains("active");

                    if (isActive) {
                        toggleElement.classList.remove("active");
                        this.settings[setting] = false;
                    } else {
                        toggleElement.classList.add("active");
                        this.settings[setting] = true;
                    }

                    this.saveSettings();
                    this.applySetting(setting, this.settings[setting]);
                }

                applySetting(setting, value) {
                    if (!this.pwaManager) return;

                    switch (setting) {
                        case "notifications":
                            if (value) {
                                this.pwaManager.enableNotifications();
                            }
                            break;
                        case "prefetch":
                            this.pwaManager.options.enablePrefetch = value;
                            break;
                        case "backgroundSync":
                            this.pwaManager.options.enableBackgroundSync =
                                value;
                            break;
                        case "autoUpdate":
                            // ÂÆûÁé∞Ëá™Âä®Êõ¥Êñ∞ÈÄªËæë
                            break;
                        case "developerMode":
                            if (value) {
                                console.log(
                                    "[PWA Settings] Developer mode enabled",
                                );
                            }
                            break;
                    }

                    this.pwaManager.saveSettings();
                }

                async updateCacheInfo() {
                    try {
                        // ËÆ°ÁÆóÁºìÂ≠òÂ§ßÂ∞è
                        const cacheNames = await caches.keys();
                        let totalSize = 0;
                        let fileCount = 0;

                        for (const cacheName of cacheNames) {
                            const cache = await caches.open(cacheName);
                            const keys = await cache.keys();
                            fileCount += keys.length;

                            for (const request of keys) {
                                try {
                                    const response = await cache.match(request);
                                    if (response) {
                                        const size =
                                            await this.getResponseSize(
                                                response,
                                            );
                                        totalSize += size;
                                    }
                                } catch (error) {
                                    // ÂøΩÁï•Âçï‰∏™Êñá‰ª∂ÁöÑÈîôËØØ
                                }
                            }
                        }

                        document.getElementById("cacheSize").textContent =
                            this.formatBytes(totalSize);
                        document.getElementById("dataFiles").textContent =
                            fileCount;

                        // Êõ¥Êñ∞ÊúÄÂêéÊõ¥Êñ∞Êó∂Èó¥
                        const lastUpdate =
                            localStorage.getItem("pwa-last-update");
                        document.getElementById("lastUpdate").textContent =
                            lastUpdate
                                ? new Date(lastUpdate).toLocaleString()
                                : "‰ªéÊú™";
                    } catch (error) {
                        console.error(
                            "[PWA Settings] Failed to get cache info:",
                            error,
                        );
                        document.getElementById("cacheSize").textContent =
                            "ËÆ°ÁÆóÂ§±Ë¥•";
                    }
                }

                async getResponseSize(response) {
                    try {
                        const blob = await response.clone().blob();
                        return blob.size;
                    } catch (error) {
                        return 0;
                    }
                }

                formatBytes(bytes) {
                    if (bytes === 0) return "0 Bytes";
                    const k = 1024;
                    const sizes = ["Bytes", "KB", "MB", "GB"];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return (
                        parseFloat((bytes / Math.pow(k, i)).toFixed(2)) +
                        " " +
                        sizes[i]
                    );
                }

                updateSystemInfo() {
                    const info = {
                        Áî®Êà∑‰ª£ÁêÜ: navigator.userAgent,
                        Âπ≥Âè∞: navigator.platform,
                        ËØ≠Ë®Ä: navigator.language,
                        Âú®Á∫øÁä∂ÊÄÅ: navigator.onLine ? "Âú®Á∫ø" : "Á¶ªÁ∫ø",
                        Â±èÂπïÂàÜËæ®Áéá: `${screen.width}x${screen.height}`,
                        ËßÜÁ™óÂ§ßÂ∞è: `${window.innerWidth}x${window.innerHeight}`,
                        "Service Worker ÊîØÊåÅ":
                            "serviceWorker" in navigator ? "ÊòØ" : "Âê¶",
                        Êé®ÈÄÅÈÄöÁü•ÊîØÊåÅ: "Notification" in window ? "ÊòØ" : "Âê¶",
                        "ÁºìÂ≠ò API ÊîØÊåÅ": "caches" in window ? "ÊòØ" : "Âê¶",
                        "IndexedDB ÊîØÊåÅ": "indexedDB" in window ? "ÊòØ" : "Âê¶",
                    };

                    const systemInfo = Object.entries(info)
                        .map(([key, value]) => `${key}: ${value}`)
                        .join("\n");

                    document.getElementById("systemInfo").textContent =
                        systemInfo;
                }

                async refreshCache() {
                    const button =
                        document.getElementById("refreshCacheButton");
                    const originalText = button.textContent;

                    button.innerHTML =
                        '<span class="pwa-loading"></span> Âà∑Êñ∞‰∏≠...';
                    button.disabled = true;

                    try {
                        if (this.pwaManager?.swRegistration) {
                            await this.pwaManager.swRegistration.update();
                        }

                        // Êõ¥Êñ∞ÁºìÂ≠ò‰ø°ÊÅØ
                        await this.updateCacheInfo();
                        localStorage.setItem(
                            "pwa-last-update",
                            new Date().toISOString(),
                        );

                        this.showAlert("success", "ÁºìÂ≠òÂà∑Êñ∞ÊàêÂäüÔºÅ");
                    } catch (error) {
                        console.error(
                            "[PWA Settings] Cache refresh failed:",
                            error,
                        );
                        this.showAlert(
                            "error",
                            "ÁºìÂ≠òÂà∑Êñ∞Â§±Ë¥•Ôºö" + error.message,
                        );
                    }

                    button.textContent = originalText;
                    button.disabled = false;
                }

                async clearCache() {
                    if (
                        !confirm("Á°ÆÂÆöË¶ÅÊ∏ÖÁêÜÊâÄÊúâÁºìÂ≠òÂêóÔºüËøôÂ∞ÜÂà†Èô§ÊâÄÊúâÁ¶ªÁ∫øÊï∞ÊçÆ„ÄÇ")
                    ) {
                        return;
                    }

                    const button = document.getElementById("clearCacheButton");
                    const originalText = button.textContent;

                    button.innerHTML =
                        '<span class="pwa-loading"></span> Ê∏ÖÁêÜ‰∏≠...';
                    button.disabled = true;

                    try {
                        if (this.pwaManager) {
                            await this.pwaManager.clearCache();
                        }

                        // Êõ¥Êñ∞ÁºìÂ≠ò‰ø°ÊÅØ
                        await this.updateCacheInfo();

                        this.showAlert("success", "ÁºìÂ≠òÊ∏ÖÁêÜÂÆåÊàêÔºÅ");
                    } catch (error) {
                        console.error(
                            "[PWA Settings] Cache clear failed:",
                            error,
                        );
                        this.showAlert(
                            "error",
                            "ÁºìÂ≠òÊ∏ÖÁêÜÂ§±Ë¥•Ôºö" + error.message,
                        );
                    }

                    button.textContent = originalText;
                    button.disabled = false;
                }

                async downloadOfflineData() {
                    const button = document.getElementById(
                        "downloadOfflineButton",
                    );
                    const originalText = button.textContent;

                    button.innerHTML =
                        '<span class="pwa-loading"></span> ‰∏ãËΩΩ‰∏≠...';
                    button.disabled = true;

                    try {
                        // Ëé∑ÂèñÊúÄÊñ∞ÁöÑËÆ∫ÊñáÊï∞ÊçÆÊñá‰ª∂
                        const response = await fetch("/assets/file-list.txt");
                        const fileList = await response.text();
                        const files = fileList
                            .split("\n")
                            .filter((line) => line.trim())
                            .slice(-5) // ÊúÄÊñ∞5‰∏™Êñá‰ª∂
                            .map((file) => `/data/${file}`);

                        if (this.pwaManager) {
                            this.pwaManager.sendMessageToSW("PREFETCH_DATA", {
                                urls: files,
                            });
                        }

                        this.showAlert(
                            "success",
                            `Â∑≤ÂºÄÂßã‰∏ãËΩΩ ${files.length} ‰∏™Êï∞ÊçÆÊñá‰ª∂`,
                        );
                    } catch (error) {
                        console.error("[PWA Settings] Download failed:", error);
                        this.showAlert("error", "‰∏ãËΩΩÂ§±Ë¥•Ôºö" + error.message);
                    }

                    button.textContent = originalText;
                    button.disabled = false;
                }

                exportSettings() {
                    const exportData = {
                        pwaSettings: this.settings,
                        appSettings: {
                            preferredKeywords: JSON.parse(
                                localStorage.getItem("preferredKeywords") ||
                                    "[]",
                            ),
                            preferredAuthors: JSON.parse(
                                localStorage.getItem("preferredAuthors") ||
                                    "[]",
                            ),
                        },
                        timestamp: new Date().toISOString(),
                    };

                    const blob = new Blob(
                        [JSON.stringify(exportData, null, 2)],
                        { type: "application/json" },
                    );
                    const url = URL.createObjectURL(blob);

                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `pwa-settings-${new Date().toISOString().split("T")[0]}.json`;
                    a.click();

                    URL.revokeObjectURL(url);
                    this.showAlert("success", "ËÆæÁΩÆÂØºÂá∫ÊàêÂäüÔºÅ");
                }

                async importSettings(file) {
                    if (!file) return;

                    try {
                        const text = await file.text();
                        const importData = JSON.parse(text);

                        if (importData.pwaSettings) {
                            this.settings = {
                                ...this.settings,
                                ...importData.pwaSettings,
                            };
                            this.saveSettings();
                        }

                        if (importData.appSettings) {
                            if (importData.appSettings.preferredKeywords) {
                                localStorage.setItem(
                                    "preferredKeywords",
                                    JSON.stringify(
                                        importData.appSettings
                                            .preferredKeywords,
                                    ),
                                );
                            }
                            if (importData.appSettings.preferredAuthors) {
                                localStorage.setItem(
                                    "preferredAuthors",
                                    JSON.stringify(
                                        importData.appSettings.preferredAuthors,
                                    ),
                                );
                            }
                        }

                        this.showAlert(
                            "success",
                            "ËÆæÁΩÆÂØºÂÖ•ÊàêÂäüÔºÅÈ°µÈù¢Â∞ÜÂú®3ÁßíÂêéÂà∑Êñ∞",
                        );
                        setTimeout(() => window.location.reload(), 3000);
                    } catch (error) {
                        console.error("[PWA Settings] Import failed:", error);
                        this.showAlert("error", "ÂØºÂÖ•Â§±Ë¥•Ôºö" + error.message);
                    }
                }

                resetSettings() {
                    if (!confirm("Á°ÆÂÆöË¶ÅÈáçÁΩÆÊâÄÊúâPWAËÆæÁΩÆÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ")) {
                        return;
                    }

                    // ÈáçÁΩÆPWAËÆæÁΩÆ
                    localStorage.removeItem("pwa-settings");
                    this.settings = this.getDefaultSettings();
                    this.saveSettings();

                    // Êõ¥Êñ∞UI
                    this.updateSettingsUI();

                    this.showAlert("success", "ËÆæÁΩÆÈáçÁΩÆÂÆåÊàêÔºÅ");
                }

                showAlert(type, message) {
                    const alertDiv = document.getElementById("cacheAlert");
                    alertDiv.innerHTML = `
                        <div class="pwa-alert ${type}">
                            <span>${type === "success" ? "‚úÖ" : type === "warning" ? "‚ö†Ô∏è" : type === "error" ? "‚ùå" : "‚ÑπÔ∏è"}</span>
                            <div>${message}</div>
                        </div>
                    `;

                    setTimeout(() => {
                        alertDiv.innerHTML = "";
                    }, 5000);
                }

                loadSettings() {
                    const defaults = this.getDefaultSettings();
                    const saved = JSON.parse(
                        localStorage.getItem("pwa-settings") || "{}",
                    );
                    return { ...defaults, ...saved };
                }

                getDefaultSettings() {
                    return {
                        notifications: false,
                        prefetch: true,
                        backgroundSync: true,
                        autoUpdate: true,
                        developerMode: false,
                    };
                }

                saveSettings() {
                    localStorage.setItem(
                        "pwa-settings",
                        JSON.stringify(this.settings),
                    );
                }

                updateSettingsUI() {
                    document
                        .querySelectorAll(".pwa-toggle-switch")
                        .forEach((toggle) => {
                            const setting = toggle.dataset.setting;
                            if (this.settings[setting]) {
                                toggle.classList.add("active");
                            } else {
                                toggle.classList.remove("active");
                            }
                        });
                }
            }

            // ÂàùÂßãÂåñPWAËÆæÁΩÆÁÆ°ÁêÜÂô®
            document.addEventListener("DOMContentLoaded", () => {
                if (window.pwaManager) {
                    window.pwaSettingsManager = new PWASettingsManager();
                } else {
                    // Á≠âÂæÖPWAÁÆ°ÁêÜÂô®Âä†ËΩΩ
                    const checkPWAManager = () => {
                        if (window.pwaManager) {
                            window.pwaSettingsManager =
                                new PWASettingsManager();
                        } else {
                            setTimeout(checkPWAManager, 100);
                        }
                    };
                    checkPWAManager();
                }
            });
        </script>
    </body>
</html>
